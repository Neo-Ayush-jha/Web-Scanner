<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Web IP & Port Scanner</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: #0a0a0a;
        color: #f5f5f5;
        margin: 0;
        padding: 0;
      }

      header {
        background: #111;
        padding: 20px 40px;
        border-bottom: 1px solid #222;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header h1 {
        color: #00ffc6;
        font-size: 1.6rem;
        letter-spacing: 1px;
      }

      header a {
        color: #ccc;
        text-decoration: none;
        margin-left: 20px;
        transition: color 0.3s;
      }

      header a:hover {
        color: #00ffc6;
      }

      main {
        max-width: 700px;
        margin: 60px auto;
        background: #111;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 0 25px rgba(0, 255, 198, 0.08);
      }

      h2 {
        text-align: center;
        color: #00ffc6;
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-top: 20px;
        color: #ccc;
      }

      input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #333;
        margin-top: 6px;
        background: #1a1a1a;
        color: #eee;
      }

      input:focus {
        outline: none;
        border-color: #00ffc6;
      }

      button {
        margin-top: 25px;
        background: #00ffc6;
        color: #000;
        border: none;
        padding: 12px 28px;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 600;
        width: 100%;
        transition: background 0.3s, transform 0.2s;
      }

      button:hover {
        background: #00d4a3;
        transform: scale(1.03);
      }

      #statusArea {
        display: none;
        margin-top: 30px;
        background: #1a1a1a;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #222;
      }

      #scanStatus {
        color: #00ffc6;
        font-weight: 600;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      th,
      td {
        border: 1px solid #222;
        padding: 8px 10px;
        text-align: center;
      }

      th {
        background: #222;
        color: #00ffc6;
      }

      .open {
        color: #00ff7f;
        font-weight: 600;
      }

      .closed {
        color: #aaa;
      }

      .filtered {
        color: orange;
      }

      #downloadBtn {
        display: none;
        margin-top: 20px;
        background: #00ffc6;
        color: #000;
        border: none;
        padding: 10px 24px;
        border-radius: 30px;
        cursor: pointer;
        transition: background 0.3s;
      }

      #downloadBtn:hover {
        background: #00d4a3;
      }

      .loading-dots {
        display: inline-block;
        font-weight: bold;
        animation: blink 1.5s infinite;
      }

      @keyframes blink {
        0%,
        20% {
          opacity: 0.2;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.2;
        }
      }

      footer {
        text-align: center;
        color: #888;
        padding: 20px;
        font-size: 0.9rem;
      }

      #ipDisplay {
        margin-top: 10px;
        color: #00ffc6;
        font-weight: 500;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>CyberTool Scanner</h1>
      <nav>
        <a href="/">Home</a>
        <a href="/scanner/">Scanner</a>
      </nav>
    </header>

    <main>
      <h2>Web IP & Port Scanner</h2>

      <label for="target">Target (IP or Domain)</label>
      <input id="target" placeholder="example.com or 45.33.32.156" autocomplete="off" />
      <button id="resolveBtn">üåê Resolve Domain to IP</button>
      <div id="ipDisplay"></div>

      <label for="ports">Ports (Range or Comma-separated)</label>
      <input id="ports" placeholder="1-1024 or 22,80,443" value="1-1024" autocomplete="off" />

      <button id="startBtn">üöÄ Start Scan</button>

      <div id="statusArea">
        <h3>
          Scan Status:
          <span id="scanStatus">Waiting...</span>
          <span class="loading-dots">...</span>
        </h3>
        <div id="resultArea"></div>
        <button id="downloadBtn">‚¨áÔ∏è Download CSV</button>
      </div>
    </main>

    <footer>¬© 2025 CyberTool Scanner. Built with Django & Celery.</footer>

    <script>
      const startBtn = document.getElementById("startBtn");
      const resolveBtn = document.getElementById("resolveBtn");
      const ipDisplay = document.getElementById("ipDisplay");
      const statusArea = document.getElementById("statusArea");
      const statusEl = document.getElementById("scanStatus");
      const resultArea = document.getElementById("resultArea");
      const downloadBtn = document.getElementById("downloadBtn");

      // üåê Resolve domain to IP
      resolveBtn.addEventListener("click", async () => {
        const domain = document.getElementById("target").value.trim();
        if (!domain) {
          alert("‚ö†Ô∏è Please enter a domain name.");
          return;
        }

        ipDisplay.textContent = "Resolving...";
        const resp = await fetch("/api/resolve_domain/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ domain }),
        });
        const data = await resp.json();

        if (resp.ok) {
          ipDisplay.textContent = `‚úÖ IP Address: ${data.ip_address}`;
          document.getElementById("target").value = data.ip_address;
        } else {
          ipDisplay.textContent = `‚ùå ${data.error}`;
        }
      });

      // üöÄ Start Scan
      startBtn.addEventListener("click", async () => {
        const target = document.getElementById("target").value.trim();
        const ports = document.getElementById("ports").value.trim() || "1-1024";

        if (!target) {
          alert("‚ö†Ô∏è Please enter a valid target (IP or domain).");
          return;
        }

        statusArea.style.display = "block";
        statusEl.textContent = "Starting...";
        resultArea.innerHTML = "<em>Initializing scan...</em>";

        const resp = await fetch("/api/start_scan/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target, ports }),
        });
        const data = await resp.json();

        if (resp.ok) pollStatus(data.scan_db_id);
        else alert("‚ùå Error: " + JSON.stringify(data));
      });

      // Poll scan status
      let pollInterval;
      async function pollStatus(scan_db_id) {
        async function check() {
          const r = await fetch(`/api/status/${scan_db_id}/`);
          const j = await r.json();
          statusEl.textContent = j.status;

          if (j.results && j.results.length > 0) {
            let html =
              "<table><thead><tr><th>Port</th><th>State</th><th>Service</th></tr></thead><tbody>";
            j.results.forEach((row) => {
              html += `<tr><td>${row.port}</td><td class="${row.state}">${row.state}</td><td>${row.service || ""}</td></tr>`;
            });
            html += "</tbody></table>";
            resultArea.innerHTML = html;
          } else {
            resultArea.innerHTML = "<em>No open ports yet ‚Äî scanning...</em>";
          }

          if (j.status === "COMPLETED" || j.status === "FAILED") {
            clearInterval(pollInterval);
            downloadBtn.style.display = "inline-block";
            downloadBtn.onclick = () =>
              (window.location = `/api/export/${scan_db_id}/`);
          }
        }

        check();
        pollInterval = setInterval(check, 3000);
      }
    </script>
  </body>
</html>
