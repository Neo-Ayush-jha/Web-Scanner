{% extends "scanner/base.html" %}
{% block title %}SPIDER — Scan & Port Inspection{% endblock %}

{% block head_style %}
{{ block.super }}
<style>
  main.scanner {
    max-width: 820px;
    margin: 60px auto;
    background: rgba(13, 17, 23, 0.55);
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 0 25px rgba(0, 255, 198, 0.08);
  }

  h2 {
    text-align: center;
    color: #00ffc6;
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-top: 20px;
    color: #ccc;
    font-weight: 600;
  }

  input {
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #333;
    margin-top: 6px;
    background: #1a1a1a;
    color: #eee;
    font-size: 1rem;
  }

  input:focus {
    outline: none;
    border-color: #00ffc6;
  }

  #messageArea {
    color: #ff4d4d;
    background: #331111;
    border: 1px solid #552222;
    padding: 10px;
    border-radius: 8px;
    margin-top: 20px;
    font-weight: 600;
    display: none;
  }

  button {
    margin-top: 25px;
    background: #00ffc6;
    color: #000;
    border: none;
    padding: 12px 28px;
    border-radius: 30px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    transition: background 0.3s, transform 0.2s, opacity 0.3s;
  }

  button:hover:not(:disabled) {
    background: #00d4a3;
    transform: scale(1.03);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #statusArea {
    display: none;
    margin-top: 30px;
    background: #1a1a1a;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #222;
  }

  #statusArea h3 {
    color: #ccc;
    font-size: 1.1rem;
    border-bottom: 1px solid #222;
    padding-bottom: 10px;
    margin-top: 0;
  }

  #scanStatus {
    color: #00ffc6;
    font-weight: 600;
    margin-left: 5px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.9rem;
  }

  th,
  td {
    border: 1px solid #222;
    padding: 10px 8px;
    text-align: center;
    vertical-align: top;
  }

  th {
    background: #222;
    color: #00ffc6;
    font-weight: 700;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .open {
    color: #00ff7f;
    font-weight: 600;
  }

  .closed {
    color: #888;
  }

  .filtered {
    color: #ffaa00;
  }

  .failed {
    color: #ff4d4d;
  }

  #downloadBtn {
    display: none;
    margin: 20px auto 0;
    background: #00ffc6;
    color: #000;
    border: none;
    padding: 10px 24px;
    border-radius: 30px;
    cursor: pointer;
    transition: background 0.3s;
    width: auto;
  }

  #downloadBtn:hover {
    background: #00d4a3;
  }

  .loading-dots {
    display: inline-block;
    font-weight: bold;
    color: #00ffc6;
    animation: blink 1.5s infinite;
  }

  @keyframes blink {
    0%,
    20% {
      opacity: 0.2;
    }
    50% {
      opacity: 1;
    }
    100% {
      opacity: 0.2;
    }
  }
</style>
{% endblock %} {% block content %}
<main class="scanner mx-auto  w-full max-w-3xl glass  rounded-xl shadow-lg">

  <h2 class="text-center brand text-2xl neon-text mb-6">
    Port & Service Enumeration
  </h2>

  <div id="messageArea"></div>

  <label for="target" class="block text-slate-300 font-semibold my-4">
    Target (IP or Domain name)
  </label>
  <input id="target"
         class="w-full px-4 py-3 rounded bg-black/40 border border-slate-700 focus:border-emerald-400"
         placeholder="example.com or 45.33.32.156" />

  <label for="ports" class="block text-slate-300 font-semibold my-4">
    Ports (Range or Comma-separated)
  </label>
  <input id="ports"
         class="w-full px-4 py-3 rounded bg-black/40 border border-slate-700 focus:border-emerald-400"
         placeholder="1-1024 or 22,80,443"
         value="1-1024" />

  <button id="startBtn"
          class="mt-6 w-full px-6 py-3 bg-emerald-400 text-black font-semibold rounded hover:bg-emerald-300 transition">
    <i class="fas fa-rocket"></i> Start Scan
  </button>

  <div id="statusArea" class="hidden mt-8 p-5 bg-black/40 border border-slate-700 rounded-lg">
      <h3 class="text-slate-200 text-lg font-semibold mb-3">
        Scan Status: <span id="scanStatus" class="text-emerald-400 font-bold"></span>
        <span class="loading-dots">...</span>
      </h3>
      <div id="resultArea"></div>

      <button id="downloadBtn"
              class="hidden mt-5 px-5 py-2 bg-emerald-400 text-black rounded hover:bg-emerald-300">
        <i class="fas fa-download"></i> Download CSV
      </button>
  </div>

</main>
{% endblock %} {% block extra_scripts %}
<script>
  const startBtn = document.getElementById("startBtn");
  const statusArea = document.getElementById("statusArea");
  const statusEl = document.getElementById("scanStatus");
  const resultArea = document.getElementById("resultArea");
  const downloadBtn = document.getElementById("downloadBtn");
  const messageArea = document.getElementById("messageArea"); // ENHANCEMENT: New element reference
  const targetInput = document.getElementById("target");
  const portsInput = document.getElementById("ports");

  // ENHANCEMENT: Helper to display errors
  function displayError(message) {
    messageArea.textContent = "❌ " + message;
    messageArea.style.display = "block";
  }

  function clearMessages() {
    messageArea.style.display = "none";
    messageArea.textContent = "";
  }

  startBtn.addEventListener("click", async () => {
    clearMessages();
    const target = targetInput.value.trim();
    const ports = portsInput.value.trim() || "1-1024";

    if (!target) {
      displayError("Please enter a valid target (IP or domain).");
      return;
    }

    // ENHANCEMENT: Disable button and show loading immediately
    startBtn.disabled = true;
    startBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> Initializing...';

    statusArea.style.display = "block";
    statusEl.textContent = "Starting...";
    resultArea.innerHTML =
      "<em>Initializing connection to backend scan worker...</em>";
    downloadBtn.style.display = "none";

    try {
      const resp = await fetch("/api/start_scan/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target, ports }),
      });

      const data = await resp.json();
      console.log("Scan started:", data);

      if (resp.ok) {
        pollStatus(data.scan_db_id);
      } else {
        // ENHANCEMENT: Handle API errors more gracefully
        const errorMsg =
          data.error || data.detail || "An unexpected API error occurred.";
        displayError("Scan failed to start: " + errorMsg);
        statusEl.textContent = "FAILED";
        resultArea.innerHTML = "";
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Scan';
      }
    } catch (error) {
      displayError("Network error: Could not reach the API server.");
      statusEl.textContent = "FAILED";
      resultArea.innerHTML = "";
      startBtn.disabled = false;
      startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Scan';
    }
  });

  let pollInterval;
  // ENHANCEMENT: Define risk level colors for table rows
  const RISK_COLORS = {
    Critical: "color: #ff4d4d; font-weight: 700;",
    High: "color: #ff7f4d; font-weight: 600;",
    Medium: "color: #ffaa00;",
    Low: "color: #00ff7f;",
  };

  async function pollStatus(scan_db_id) {
    // Clear any previous interval
    if (pollInterval) clearInterval(pollInterval);

    async function check() {
      try {
        const r = await fetch(`/api/status/${scan_db_id}/`);
        if (!r.ok) {
          throw new Error("Failed to fetch scan status.");
        }
        const j = await r.json();
        statusEl.textContent = j.status;

        // ENHANCEMENT: Conditional loading dots visibility
        const loadingDots = document.querySelector(".loading-dots");
        if (j.status === "COMPLETED" || j.status === "FAILED") {
          loadingDots.style.display = "none";
        } else {
          loadingDots.style.display = "inline-block";
        }

        if (j.results && j.results.length > 0) {
          let html = `
                <p style="color: #ccc; font-size: 0.9em; margin-bottom: 5px;">Results for ${
                  j.target || "Target"
                }:</p>
                <div style="max-height: 400px; overflow-y: auto;"> <table>
                    <thead>
                      <tr>
                        <th>Port</th>
                        <th>Name</th>
                        <th>State</th>
                        <th>Service</th>
                        <th>Risk</th>
                        <th style="text-align:left;">Description</th>
                        <th style="text-align:left;">Usage</th>
                      </tr>
                    </thead>
                    <tbody>`;

          j.results.forEach((row) => {
            // ENHANCEMENT: Use class for state, use inline style for risk based on map
            const riskStyle = RISK_COLORS[row.risk_level] || "color: #ccc;";
            html += `
                  <tr>
                    <td>${row.port}</td>
                    <td>${row.name}</td>
                    <td class="${row.state.toLowerCase()}">${row.state}</td>
                    <td>${row.service || "-"}</td>
                    <td style="${riskStyle}">${row.risk_level}</td>
                    <td style="text-align:left; max-width: 200px;">${
                      row.description
                    }</td>
                    <td style="text-align:left; max-width: 200px;">${
                      row.usage
                    }</td>
                  </tr>`;
          });
          html += "</tbody></table></div>"; // Close scrollable div and table
          resultArea.innerHTML = html;
        } else if (
          j.status === "COMPLETED" &&
          (!j.results || j.results.length === 0)
        ) {
          // ENHANCEMENT: Message for no open ports found
          resultArea.innerHTML =
            '<p style="color: #00ffc6; font-weight: 600;">✅ Scan complete. No open ports found in the specified range.</p>';
        } else if (j.status === "FAILED") {
          resultArea.innerHTML =
            '<p style="color: #ff4d4d; font-weight: 600;">❌ Scan failed. Check the target or port range.</p>';
        }

        if (j.status === "COMPLETED" || j.status === "FAILED") {
          clearInterval(pollInterval);
          // ENHANCEMENT: Re-enable start button
          startBtn.disabled = false;
          startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Scan';

          if (j.status === "COMPLETED" && j.results && j.results.length > 0) {
            downloadBtn.style.display = "inline-block";
            downloadBtn.onclick = () =>
              (window.location = `/api/export/${scan_db_id}/`);
          }
        }
      } catch (e) {
        console.error("Polling error:", e);
        clearInterval(pollInterval);
        statusEl.textContent = "ERROR";
        resultArea.innerHTML =
          '<p style="color: #ff4d4d; font-weight: 600;">A communication error occurred during status check.</p>';
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-rocket"></i> Start Scan';
        const loadingDots = document.querySelector(".loading-dots");
        loadingDots.style.display = "none";
      }
    }

    check();
    // Start polling every 3 seconds
    pollInterval = setInterval(check, 3000);
  }
</script>
{% endblock %}
